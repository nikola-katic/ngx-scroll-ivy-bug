/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { coerceBooleanProperty, coerceNumberProperty } from '@angular/cdk/coercion';
import { animationFrameScheduler, asyncScheduler, EMPTY, fromEvent, merge, of, Subject } from 'rxjs';
import { distinctUntilChanged, map, mergeMap, pluck, switchMap, takeUntil, tap } from 'rxjs/operators';
/**
 * @abstract
 */
var /**
 * @abstract
 */
ScrollbarRef = /** @class */ (function () {
    function ScrollbarRef(scrollbarRef, document, trackRef, thumbRef, platform, destroyed) {
        var _this = this;
        this.scrollbarRef = scrollbarRef;
        this.document = document;
        this.destroyed = destroyed;
        this.viewElement = scrollbarRef.viewport;
        this.trackElement = trackRef.nativeElement;
        this.thumbElement = thumbRef.nativeElement;
        if (!(platform.IOS || platform.ANDROID)) {
            this.pointerEvents = new Subject();
            this.hoveredState = new Subject();
            this.draggingState = new Subject();
            this.draggingState.pipe(distinctUntilChanged(), tap((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return _this.setDragging(state); })), takeUntil(this.destroyed)).subscribe();
            /** @type {?} */
            var scrollbarClicked_1 = fromEvent(this.viewElement, 'mousedown', { passive: true }).pipe(switchMap((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.stopPropagation();
                _this.document.onselectstart = (/**
                 * @return {?}
                 */
                function () { return false; });
                /** @type {?} */
                var isThumbClick = isWithinBounds(e, _this.thumbElement.getBoundingClientRect());
                if (isThumbClick && !coerceBooleanProperty(_this.scrollbarRef.thumbDragDisabled)) {
                    return _this.dragged(e);
                }
                else {
                    /** @type {?} */
                    var isTrackClick = isWithinBounds(e, _this.trackElement.getBoundingClientRect());
                    if (isTrackClick && !coerceBooleanProperty(_this.scrollbarRef.trackClickDisabled)) {
                        return _this.trackClicked(e);
                    }
                }
                return EMPTY;
            })));
            // Activate/Deactivate scrollbar hover event
            /** @type {?} */
            var mouseLeave = fromEvent(this.viewElement, 'mouseleave').pipe(map((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.stopPropagation();
                return false;
            })));
            merge(this.pointerEvents, mouseLeave).pipe(distinctUntilChanged()).pipe(tap((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return _this.setHovered(state); })), takeUntil(this.destroyed)).subscribe();
            // Activate/Deactivate scrollTo on scrollbar click event
            this.pointerEvents.pipe(distinctUntilChanged(), switchMap((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return state ? scrollbarClicked_1 : EMPTY; })), takeUntil(this.destroyed)).subscribe();
            this.hovered().pipe(tap((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return _this.pointerEvents.next(state); })), takeUntil(this.destroyed)).subscribe();
        }
        // Start updating thumb position when view scrolls
        this.scrolled().pipe(tap((/**
         * @return {?}
         */
        function () { return _this.updateThumb(); })), takeUntil(this.destroyed)).subscribe();
        // Update scrollbar when `NgScrollbar.update()` is called
        this.scrollbarRef.updated.pipe(tap((/**
         * @return {?}
         */
        function () { return _this.updateThumb(); })), takeUntil(this.destroyed)).subscribe();
        // Initialize scrollbar
        asyncScheduler.schedule((/**
         * @return {?}
         */
        function () { return _this.updateThumb(); }), 100);
    }
    Object.defineProperty(ScrollbarRef.prototype, "scrollMax", {
        // The available scrollable size
        get: 
        // The available scrollable size
        /**
         * @protected
         * @return {?}
         */
        function () {
            return this.scrollSize - this.viewportSize;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ScrollbarRef.prototype, "trackMax", {
        get: /**
         * @protected
         * @return {?}
         */
        function () {
            return this.trackSize - this.thumbSize;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Updates scrollbar's thumb position and size
     */
    /**
     * Updates scrollbar's thumb position and size
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.updateThumb = /**
     * Updates scrollbar's thumb position and size
     * @protected
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var trackMax = this.trackMax;
        /** @type {?} */
        var size = calculateThumbSize(this.trackSize, this.scrollSize, this.scrollbarRef.minThumbSize);
        /** @type {?} */
        var position = calculateThumbPosition(this.scrollOffset, this.scrollMax, trackMax);
        animationFrameScheduler.schedule((/**
         * @return {?}
         */
        function () { return _this.applyThumbStyle(size, position, trackMax); }));
    };
    /**
     * @param {?} event
     * @return {?}
     */
    ScrollbarRef.prototype.dragged = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        /** @type {?} */
        var trackMax;
        /** @type {?} */
        var scrollMax;
        /** @type {?} */
        var dragStart = of(event).pipe(tap((/**
         * @return {?}
         */
        function () {
            // Capture scrollMax and trackMax once
            trackMax = _this.trackMax;
            scrollMax = _this.scrollMax;
            _this.draggingState.next(true);
        })));
        /** @type {?} */
        var dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return e.stopPropagation(); })));
        /** @type {?} */
        var dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.stopPropagation();
            _this.document.onselectstart = null;
            _this.draggingState.next(false);
        })));
        return dragStart.pipe(pluck(this.pageProperty), map((/**
         * @param {?} pageOffset
         * @return {?}
         */
        function (pageOffset) { return pageOffset - _this.dragStartOffset; })), mergeMap((/**
         * @param {?} mouseDownOffset
         * @return {?}
         */
        function (mouseDownOffset) { return dragging.pipe(pluck(_this.clientProperty), 
        // Calculate how far the user's mouse is from the top/left of the scrollbar (minus the dragOffset).
        map((/**
         * @param {?} mouseOffset
         * @return {?}
         */
        function (mouseOffset) { return mouseOffset - _this.dragOffset; })), map((/**
         * @param {?} offset
         * @return {?}
         */
        function (offset) { return scrollMax * (offset - mouseDownOffset) / trackMax; })), map((/**
         * @param {?} position
         * @return {?}
         */
        function (position) { return _this.handleDragPosition(position, scrollMax); })), tap((/**
         * @param {?} value
         * @return {?}
         */
        function (value) { return _this.scrollTo(value); })), takeUntil(dragEnd)); })));
    };
    /**
     * Stream that emits when a scrollbar is hovered
     */
    /**
     * Stream that emits when a scrollbar is hovered
     * @private
     * @return {?}
     */
    ScrollbarRef.prototype.hovered = /**
     * Stream that emits when a scrollbar is hovered
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        return fromEvent(this.viewElement, 'mousemove', { passive: true }).pipe(map((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.stopPropagation();
            return isWithinBounds(e, _this.trackElement.getBoundingClientRect());
        })));
    };
    /**
     * Stream that emits when scrollbar track is clicked
     */
    /**
     * Stream that emits when scrollbar track is clicked
     * @protected
     * @param {?} e
     * @return {?}
     */
    ScrollbarRef.prototype.trackClicked = /**
     * Stream that emits when scrollbar track is clicked
     * @protected
     * @param {?} e
     * @return {?}
     */
    function (e) {
        var _this = this;
        return of(e).pipe(pluck(this.pageProperty), map((/**
         * @param {?} pageOffset
         * @return {?}
         */
        function (pageOffset) { return pageOffset - _this.dragOffset; })), map((/**
         * @param {?} clickOffset
         * @return {?}
         */
        function (clickOffset) {
            /** @type {?} */
            var offset = clickOffset - (_this.thumbSize / 2);
            /** @type {?} */
            var ratio = offset / _this.trackSize;
            return ratio * _this.scrollSize;
        })), tap((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            return _this.scrollbarRef.scrollTo(tslib_1.__assign({}, _this.mapToScrollToOption(value), { duration: coerceNumberProperty(_this.scrollbarRef.trackClickScrollDuration) }));
        })), tap((/**
         * @return {?}
         */
        function () { return _this.document.onselectstart = null; })));
    };
    return ScrollbarRef;
}());
/**
 * @abstract
 */
export { ScrollbarRef };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.viewElement;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.trackElement;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.thumbElement;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.hoveredState;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.draggingState;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.pointerEvents;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.scrollbarRef;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.document;
    /**
     * @type {?}
     * @protected
     */
    ScrollbarRef.prototype.destroyed;
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.scrollSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.viewportSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.trackSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.thumbSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.scrollOffset = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.dragStartOffset = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.dragOffset = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.pageProperty = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.clientProperty = function () { };
    /**
     * Stream that emits when view is scrolled
     * @abstract
     * @protected
     * @return {?}
     */
    ScrollbarRef.prototype.scrolled = function () { };
    /**
     * Return a scrollTo option parameter
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    ScrollbarRef.prototype.mapToScrollToOption = function (value) { };
    /**
     * Updates scrollbar's thumb size and position
     * @abstract
     * @protected
     * @param {?} size
     * @param {?} position
     * @param {?=} trackMax
     * @return {?}
     */
    ScrollbarRef.prototype.applyThumbStyle = function (size, position, trackMax) { };
    /**
     * On drag function
     * @abstract
     * @protected
     * @param {?} position
     * @param {?} scrollMax
     * @return {?}
     */
    ScrollbarRef.prototype.handleDragPosition = function (position, scrollMax) { };
    /**
     * @abstract
     * @protected
     * @param {?} point
     * @return {?}
     */
    ScrollbarRef.prototype.scrollTo = function (point) { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    ScrollbarRef.prototype.setDragging = function (value) { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    ScrollbarRef.prototype.setHovered = function (value) { };
}
/**
 * Calculate Scrollbar thumb size
 * @param {?} trackSize Scrollbar track size
 * @param {?} contentSize Content size or Viewport scroll size
 * @param {?} minThumbSize Minimum scrollbar thumb size
 * @return {?}
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    /** @type {?} */
    var scrollbarRatio = trackSize / contentSize;
    /** @type {?} */
    var thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 * @param {?} scrollPosition The scroll position of the viewport
 * @param {?} scrollMax The max size available to scroll the viewport
 * @param {?} trackMax The max size available to move scrollbar thumb
 * @return {?}
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
/**
 * Check if pointer is within scrollbar bounds
 * @param {?} e Pointer event
 * @param {?} rect Scrollbar Client Rect
 * @return {?}
 */
function isWithinBounds(e, rect) {
    return (e.clientX >= rect.left &&
        e.clientX <= rect.left + rect.width &&
        e.clientY >= rect.top &&
        e.clientY <= rect.top + rect.height);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLXJlZi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1zY3JvbGxiYXIvIiwic291cmNlcyI6WyJsaWIvY2xhc3Nlcy9zY3JvbGxiYXItcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUEsT0FBTyxFQUFFLHFCQUFxQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDcEYsT0FBTyxFQUFFLHVCQUF1QixFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pILE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBSXZHOzs7O0lBdUNFLHNCQUFnQyxZQUF5QixFQUN6QixRQUFhLEVBQ3ZCLFFBQW9CLEVBQ3BCLFFBQW9CLEVBQ3BCLFFBQWtCLEVBQ1IsU0FBd0I7UUFMeEQsaUJBOEVDO1FBOUUrQixpQkFBWSxHQUFaLFlBQVksQ0FBYTtRQUN6QixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBSWIsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUN0RCxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDekMsSUFBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBQzNDLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUUzQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUV2QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7WUFDNUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1lBQzNDLElBQUksQ0FB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R0FBRyxJQUFJLENBQUMsTUFBTSxDQUNwQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBjb2VyY2VCb29sZWFuUHJvcGVydHksIGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcclxuaW1wb3J0IHsgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIsIGFzeW5jU2NoZWR1bGVyLCBFTVBUWSwgZnJvbUV2ZW50LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgbWVyZ2VNYXAsIHBsdWNrLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi9uZy1zY3JvbGxiYXInO1xyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNjcm9sbGJhclJlZiB7XHJcbiAgLy8gU2Nyb2xsYWJsZSB2aWV3IGVsZW1lbnRcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgdmlld0VsZW1lbnQ6IEhUTUxFbGVtZW50O1xyXG4gIHByb3RlY3RlZCByZWFkb25seSB0cmFja0VsZW1lbnQ6IEhUTUxFbGVtZW50O1xyXG4gIHByb3RlY3RlZCByZWFkb25seSB0aHVtYkVsZW1lbnQ6IEhUTUxFbGVtZW50O1xyXG5cclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgaG92ZXJlZFN0YXRlOiBTdWJqZWN0PGJvb2xlYW4+O1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBkcmFnZ2luZ1N0YXRlOiBTdWJqZWN0PGJvb2xlYW4+O1xyXG5cclxuICAvLyBQb2ludGVyIGV2ZW50cyBzd2l0Y2hlciBzdHJlYW1cclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgcG9pbnRlckV2ZW50czogU3ViamVjdDxib29sZWFuPjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBzY3JvbGxTaXplKCk6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNpemUoKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHRyYWNrU2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdGh1bWJTaXplKCk6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBzY3JvbGxPZmZzZXQoKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IGRyYWdTdGFydE9mZnNldCgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgZHJhZ09mZnNldCgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgcGFnZVByb3BlcnR5KCk6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBjbGllbnRQcm9wZXJ0eSgpOiBzdHJpbmc7XHJcblxyXG4gIC8vIFRoZSBhdmFpbGFibGUgc2Nyb2xsYWJsZSBzaXplXHJcbiAgcHJvdGVjdGVkIGdldCBzY3JvbGxNYXgoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLnNjcm9sbFNpemUgLSB0aGlzLnZpZXdwb3J0U2l6ZTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBnZXQgdHJhY2tNYXgoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLnRyYWNrU2l6ZSAtIHRoaXMudGh1bWJTaXplO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBzY3JvbGxiYXJSZWY6IE5nU2Nyb2xsYmFyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgZG9jdW1lbnQ6IGFueSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRodW1iUmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwbGF0Zm9ybTogUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBkZXN0cm95ZWQ6IFN1YmplY3Q8dm9pZD4pIHtcclxuICAgIHRoaXMudmlld0VsZW1lbnQgPSBzY3JvbGxiYXJSZWYudmlld3BvcnQ7XHJcbiAgICB0aGlzLnRyYWNrRWxlbWVudCA9IHRyYWNrUmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB0aGlzLnRodW1iRWxlbWVudCA9IHRodW1iUmVmLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgaWYgKCEocGxhdGZvcm0uSU9TIHx8IHBsYXRmb3JtLkFORFJPSUQpKSB7XHJcblxyXG4gICAgICB0aGlzLnBvaW50ZXJFdmVudHMgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xyXG4gICAgICB0aGlzLmhvdmVyZWRTdGF0ZSA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcbiAgICAgIHRoaXMuZHJhZ2dpbmdTdGF0ZSA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcblxyXG4gICAgICB0aGlzLmRyYWdnaW5nU3RhdGUucGlwZShcclxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICAgIHRhcCgoc3RhdGU6IGJvb2xlYW4pID0+IHRoaXMuc2V0RHJhZ2dpbmcoc3RhdGUpKSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICBjb25zdCBzY3JvbGxiYXJDbGlja2VkID0gZnJvbUV2ZW50KHRoaXMudmlld0VsZW1lbnQsICdtb3VzZWRvd24nLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShcclxuICAgICAgICBzd2l0Y2hNYXAoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgIHRoaXMuZG9jdW1lbnQub25zZWxlY3RzdGFydCA9ICgpID0+IGZhbHNlO1xyXG4gICAgICAgICAgY29uc3QgaXNUaHVtYkNsaWNrID0gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50aHVtYkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpO1xyXG4gICAgICAgICAgaWYgKGlzVGh1bWJDbGljayAmJiAhY29lcmNlQm9vbGVhblByb3BlcnR5KHRoaXMuc2Nyb2xsYmFyUmVmLnRodW1iRHJhZ0Rpc2FibGVkKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kcmFnZ2VkKGUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgaXNUcmFja0NsaWNrID0gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50cmFja0VsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpO1xyXG4gICAgICAgICAgICBpZiAoaXNUcmFja0NsaWNrICYmICFjb2VyY2VCb29sZWFuUHJvcGVydHkodGhpcy5zY3JvbGxiYXJSZWYudHJhY2tDbGlja0Rpc2FibGVkKSkge1xyXG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYWNrQ2xpY2tlZChlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBBY3RpdmF0ZS9EZWFjdGl2YXRlIHNjcm9sbGJhciBob3ZlciBldmVudFxyXG4gICAgICBjb25zdCBtb3VzZUxlYXZlID0gZnJvbUV2ZW50KHRoaXMudmlld0VsZW1lbnQsICdtb3VzZWxlYXZlJykucGlwZShcclxuICAgICAgICBtYXAoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgICBtZXJnZSh0aGlzLnBvaW50ZXJFdmVudHMsIG1vdXNlTGVhdmUpLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSkucGlwZShcclxuICAgICAgICB0YXAoKHN0YXRlOiBib29sZWFuKSA9PiB0aGlzLnNldEhvdmVyZWQoc3RhdGUpKSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICAvLyBBY3RpdmF0ZS9EZWFjdGl2YXRlIHNjcm9sbFRvIG9uIHNjcm9sbGJhciBjbGljayBldmVudFxyXG4gICAgICB0aGlzLnBvaW50ZXJFdmVudHMucGlwZShcclxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICAgIHN3aXRjaE1hcCgoc3RhdGU6IGJvb2xlYW4pID0+IHN0YXRlID8gc2Nyb2xsYmFyQ2xpY2tlZCA6IEVNUFRZKSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICB0aGlzLmhvdmVyZWQoKS5waXBlKFxyXG4gICAgICAgIHRhcCgoc3RhdGU6IGJvb2xlYW4pID0+IHRoaXMucG9pbnRlckV2ZW50cy5uZXh0KHN0YXRlKSksXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFN0YXJ0IHVwZGF0aW5nIHRodW1iIHBvc2l0aW9uIHdoZW4gdmlldyBzY3JvbGxzXHJcbiAgICB0aGlzLnNjcm9sbGVkKCkucGlwZShcclxuICAgICAgdGFwKCgpID0+IHRoaXMudXBkYXRlVGh1bWIoKSksXHJcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZClcclxuICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHNjcm9sbGJhciB3aGVuIGBOZ1Njcm9sbGJhci51cGRhdGUoKWAgaXMgY2FsbGVkXHJcbiAgICB0aGlzLnNjcm9sbGJhclJlZi51cGRhdGVkLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnVwZGF0ZVRodW1iKCkpLFxyXG4gICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICApLnN1YnNjcmliZSgpO1xyXG5cclxuICAgIC8vIEluaXRpYWxpemUgc2Nyb2xsYmFyXHJcbiAgICBhc3luY1NjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB0aGlzLnVwZGF0ZVRodW1iKCksIDEwMCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHNjcm9sbGJhcidzIHRodW1iIHBvc2l0aW9uIGFuZCBzaXplXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHVwZGF0ZVRodW1iKCk6IHZvaWQge1xyXG4gICAgY29uc3QgdHJhY2tNYXggPSB0aGlzLnRyYWNrTWF4O1xyXG4gICAgY29uc3Qgc2l6ZSA9IGNhbGN1bGF0ZVRodW1iU2l6ZSh0aGlzLnRyYWNrU2l6ZSwgdGhpcy5zY3JvbGxTaXplLCB0aGlzLnNjcm9sbGJhclJlZi5taW5UaHVtYlNpemUpO1xyXG4gICAgY29uc3QgcG9zaXRpb24gPSBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHRoaXMuc2Nyb2xsT2Zmc2V0LCB0aGlzLnNjcm9sbE1heCwgdHJhY2tNYXgpO1xyXG4gICAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4gdGhpcy5hcHBseVRodW1iU3R5bGUoc2l6ZSwgcG9zaXRpb24sIHRyYWNrTWF4KSk7XHJcbiAgfVxyXG5cclxuICBkcmFnZ2VkKGV2ZW50OiBhbnkpIHtcclxuICAgIGxldCB0cmFja01heDogbnVtYmVyO1xyXG4gICAgbGV0IHNjcm9sbE1heDogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0IGRyYWdTdGFydCA9IG9mKGV2ZW50KS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIC8vIENhcHR1cmUgc2Nyb2xsTWF4IGFuZCB0cmFja01heCBvbmNlXHJcbiAgICAgICAgdHJhY2tNYXggPSB0aGlzLnRyYWNrTWF4O1xyXG4gICAgICAgIHNjcm9sbE1heCA9IHRoaXMuc2Nyb2xsTWF4O1xyXG4gICAgICAgIHRoaXMuZHJhZ2dpbmdTdGF0ZS5uZXh0KHRydWUpO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ2dpbmcgPSBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNlbW92ZScsIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICB0YXAoKGU6IGFueSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSlcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ0VuZCA9IGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2V1cCcsIHsgY2FwdHVyZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICB0YXAoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5kb2N1bWVudC5vbnNlbGVjdHN0YXJ0ID0gbnVsbDtcclxuICAgICAgICB0aGlzLmRyYWdnaW5nU3RhdGUubmV4dChmYWxzZSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiBkcmFnU3RhcnQucGlwZShcclxuICAgICAgcGx1Y2sodGhpcy5wYWdlUHJvcGVydHkpLFxyXG4gICAgICBtYXAoKHBhZ2VPZmZzZXQ6IG51bWJlcikgPT4gcGFnZU9mZnNldCAtIHRoaXMuZHJhZ1N0YXJ0T2Zmc2V0KSxcclxuICAgICAgbWVyZ2VNYXAoKG1vdXNlRG93bk9mZnNldDogbnVtYmVyKSA9PiBkcmFnZ2luZy5waXBlKFxyXG4gICAgICAgIHBsdWNrKHRoaXMuY2xpZW50UHJvcGVydHkpLFxyXG4gICAgICAgIC8vIENhbGN1bGF0ZSBob3cgZmFyIHRoZSB1c2VyJ3MgbW91c2UgaXMgZnJvbSB0aGUgdG9wL2xlZnQgb2YgdGhlIHNjcm9sbGJhciAobWludXMgdGhlIGRyYWdPZmZzZXQpLlxyXG4gICAgICAgIG1hcCgobW91c2VPZmZzZXQ6IG51bWJlcikgPT4gbW91c2VPZmZzZXQgLSB0aGlzLmRyYWdPZmZzZXQpLFxyXG4gICAgICAgIG1hcCgob2Zmc2V0OiBudW1iZXIpID0+IHNjcm9sbE1heCAqIChvZmZzZXQgLSBtb3VzZURvd25PZmZzZXQpIC8gdHJhY2tNYXgpLFxyXG4gICAgICAgIG1hcCgocG9zaXRpb246IG51bWJlcikgPT4gdGhpcy5oYW5kbGVEcmFnUG9zaXRpb24ocG9zaXRpb24sIHNjcm9sbE1heCkpLFxyXG4gICAgICAgIHRhcCgodmFsdWU6IG51bWJlcikgPT4gdGhpcy5zY3JvbGxUbyh2YWx1ZSkpLFxyXG4gICAgICAgIHRha2VVbnRpbChkcmFnRW5kKVxyXG4gICAgICApKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gYSBzY3JvbGxiYXIgaXMgaG92ZXJlZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaG92ZXJlZCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiBmcm9tRXZlbnQodGhpcy52aWV3RWxlbWVudCwgJ21vdXNlbW92ZScsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICBtYXAoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgcmV0dXJuIGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2tFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0cmFjayBpcyBjbGlja2VkXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHRyYWNrQ2xpY2tlZChlKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgIHJldHVybiBvZihlKS5waXBlKFxyXG4gICAgICBwbHVjayh0aGlzLnBhZ2VQcm9wZXJ0eSksXHJcbiAgICAgIG1hcCgocGFnZU9mZnNldDogbnVtYmVyKSA9PiBwYWdlT2Zmc2V0IC0gdGhpcy5kcmFnT2Zmc2V0KSxcclxuICAgICAgbWFwKChjbGlja09mZnNldDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gY2xpY2tPZmZzZXQgLSAodGhpcy50aHVtYlNpemUgLyAyKTtcclxuICAgICAgICBjb25zdCByYXRpbyA9IG9mZnNldCAvIHRoaXMudHJhY2tTaXplO1xyXG4gICAgICAgIHJldHVybiByYXRpbyAqIHRoaXMuc2Nyb2xsU2l6ZTtcclxuICAgICAgfSksXHJcbiAgICAgIHRhcCgodmFsdWU6IG51bWJlcikgPT5cclxuICAgICAgICB0aGlzLnNjcm9sbGJhclJlZi5zY3JvbGxUbyh7XHJcbiAgICAgICAgICAuLi50aGlzLm1hcFRvU2Nyb2xsVG9PcHRpb24odmFsdWUpLFxyXG4gICAgICAgICAgZHVyYXRpb246IGNvZXJjZU51bWJlclByb3BlcnR5KHRoaXMuc2Nyb2xsYmFyUmVmLnRyYWNrQ2xpY2tTY3JvbGxEdXJhdGlvbilcclxuICAgICAgICB9KVxyXG4gICAgICApLFxyXG4gICAgICB0YXAoKCkgPT4gdGhpcy5kb2N1bWVudC5vbnNlbGVjdHN0YXJ0ID0gbnVsbClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHZpZXcgaXMgc2Nyb2xsZWRcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2Nyb2xsZWQoKTogT2JzZXJ2YWJsZTxhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm4gYSBzY3JvbGxUbyBvcHRpb24gcGFyYW1ldGVyXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IG1hcFRvU2Nyb2xsVG9PcHRpb24odmFsdWU6IG51bWJlcik6IFNjcm9sbFRvT3B0aW9ucztcclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyBzY3JvbGxiYXIncyB0aHVtYiBzaXplIGFuZCBwb3NpdGlvblxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBhcHBseVRodW1iU3R5bGUoc2l6ZTogbnVtYmVyLCBwb3NpdGlvbjogbnVtYmVyLCB0cmFja01heD86IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9uIGRyYWcgZnVuY3Rpb25cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgaGFuZGxlRHJhZ1Bvc2l0aW9uKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2Nyb2xsVG8ocG9pbnQ6IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXREcmFnZ2luZyh2YWx1ZTogYm9vbGVhbik6IHZvaWQ7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXRIb3ZlcmVkKHZhbHVlOiBib29sZWFuKTogdm9pZDtcclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZSBTY3JvbGxiYXIgdGh1bWIgc2l6ZVxyXG4gKiBAcGFyYW0gdHJhY2tTaXplIFNjcm9sbGJhciB0cmFjayBzaXplXHJcbiAqIEBwYXJhbSBjb250ZW50U2l6ZSBDb250ZW50IHNpemUgb3IgVmlld3BvcnQgc2Nyb2xsIHNpemVcclxuICogQHBhcmFtIG1pblRodW1iU2l6ZSBNaW5pbXVtIHNjcm9sbGJhciB0aHVtYiBzaXplXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlNpemUodHJhY2tTaXplOiBudW1iZXIsIGNvbnRlbnRTaXplOiBudW1iZXIsIG1pblRodW1iU2l6ZTogbnVtYmVyKTogbnVtYmVyIHtcclxuICBjb25zdCBzY3JvbGxiYXJSYXRpbyA9IHRyYWNrU2l6ZSAvIGNvbnRlbnRTaXplO1xyXG4gIGNvbnN0IHRodW1iU2l6ZSA9IHNjcm9sbGJhclJhdGlvICogdHJhY2tTaXplO1xyXG4gIHJldHVybiBNYXRoLm1heCh+fnRodW1iU2l6ZSwgbWluVGh1bWJTaXplKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZSBzY3JvbGxiYXIgdGh1bWIgcG9zaXRpb25cclxuICogQHBhcmFtIHNjcm9sbFBvc2l0aW9uIFRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIHZpZXdwb3J0XHJcbiAqIEBwYXJhbSBzY3JvbGxNYXggVGhlIG1heCBzaXplIGF2YWlsYWJsZSB0byBzY3JvbGwgdGhlIHZpZXdwb3J0XHJcbiAqIEBwYXJhbSB0cmFja01heCBUaGUgbWF4IHNpemUgYXZhaWxhYmxlIHRvIG1vdmUgc2Nyb2xsYmFyIHRodW1iXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHNjcm9sbFBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyLCB0cmFja01heDogbnVtYmVyKTogbnVtYmVyIHtcclxuICByZXR1cm4gc2Nyb2xsUG9zaXRpb24gKiB0cmFja01heCAvIHNjcm9sbE1heDtcclxufVxyXG5cclxuLyoqXHJcbiAqIENoZWNrIGlmIHBvaW50ZXIgaXMgd2l0aGluIHNjcm9sbGJhciBib3VuZHNcclxuICogQHBhcmFtIGUgUG9pbnRlciBldmVudFxyXG4gKiBAcGFyYW0gcmVjdCBTY3JvbGxiYXIgQ2xpZW50IFJlY3RcclxuICovXHJcbmZ1bmN0aW9uIGlzV2l0aGluQm91bmRzKGU6IGFueSwgcmVjdDogQ2xpZW50UmVjdCk6IGJvb2xlYW4ge1xyXG4gIHJldHVybiAoXHJcbiAgICBlLmNsaWVudFggPj0gcmVjdC5sZWZ0ICYmXHJcbiAgICBlLmNsaWVudFggPD0gcmVjdC5sZWZ0ICsgcmVjdC53aWR0aCAmJlxyXG4gICAgZS5jbGllbnRZID49IHJlY3QudG9wICYmXHJcbiAgICBlLmNsaWVudFkgPD0gcmVjdC50b3AgKyByZWN0LmhlaWdodFxyXG4gICk7XHJcbn1cclxuIl19